#
# Makefile
#

asc	= $(HOME)/tools/bin/asc
asdecl	= $(HOME)/tools/bin/adecl

tsc	= npx tsc
tsc_opt	= -t ES2017 --lib "es2017" --declaration --declarationDir ./types \
	  --alwaysStrict --strict --strictNullChecks --pretty

jsrun	= $(HOME)/tools/bin/jsrun

# *.as -> *.ts, *-if.d.ts
%.ts: %.as
	$(asc) --target window -f TypeScript $(asc_opt) $<
	$(asc) --target window -f TypeDeclaration $(asc_opt) $<
	mv $(<:.as=-if.d.ts) types/
	mv $(<:.as=.td) types/

# *.js -> *.ts
%.js: %.ts
	$(tsc) $(tsc_opt) $<

# source files
assrcs	= 
utssrcs	=  main.ts
ltssrcs	=  library.ts

# destination files
astsdsts	= $(assrcs:.as=.ts)
asjsdsts	= $(assrcs:.as=.js)
ujsdsts	= $(utssrcs:.ts=.js)
ljsdsts	= $(ltssrcs:.ts=.js)

# declaration files generated by adecl command
define all_builtin_if_decls
	$(shell find ./types -name "*-if.d.ts")
endef
# declaration files for user library
define all_user_lib_decls
	$(shell find ./types -name "*-lib.d.ts")
endef

all: lib_decl lib_scripts user_decl user_scripts

lib_decl: ./types/ArisiaLibrary.d.ts

./types/ArisiaLibrary.d.ts: ./types/KiwiLibrary.d.ts $(all_builtin_if_decls)
	cat ./types/KiwiLibrary.d.ts $(all_builtin_if_decls) > $@

lib_scripts:  $(ljsdsts)

user_decl: types/ArisiaPlatform.d.ts

types/ArisiaPlatform.d.ts: types/ArisiaLibrary.d.ts types/library.d.ts $(astsdsts) $(asjsdsts) $(ujsdsts) $(ljsdsts) $(all_user_lib_decls)
	cat types/ArisiaLibrary.d.ts types/library.d.ts > $@

user_scripts: $(astsdsts) $(asjsdsts) $(ujsdsts)

clean:
	rm -f $(astsdsts) $(asjsdsts) $(ujsdsts) $(ljsdsts)

dummy:

